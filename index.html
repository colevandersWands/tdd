<html>

<head>
  <meta charset="utf-8">
  <title>tdd site</title>
  <meta name="description" content="tdd site">

  <script src="https://unpkg.com/prettier@1.13.0/standalone.js"></script>
  <script src="https://unpkg.com/prettier@1.13.0/parser-babylon.js"></script>

  <link href="./testing-utils/mocha.css" rel="stylesheet" />
  <script src="./testing-utils/mocha.js"></script>
  <script src="./testing-utils/assert.js"></script>

  <script src="./ace/ace.js" type="text/javascript" charset="utf-8"></script>

  <script src="./linking/ctr-c.js"></script>
  <script src="./linking/permalinking.js"></script>



  <script>
    window.onload = () => {
      mocha.setup({
        ui: 'bdd',
        // globals: ['*']
      });

      const code = editor.getValue();
      const funcBody = code;
      (new Function(funcBody))();

      mocha.run();

      const mochaDiv = document.getElementById("mocha");
      const report = mochaDiv.lastChild;
      tries.push({ code, report });
    }
  </script>
</head>

<body>

  <header>
    <button id='run-tests'>run tests</button>
    <script>
      document.getElementById('run-tests').addEventListener('click', () => {
        document.getElementById("mocha-stats").remove();
        document.getElementById("mocha-report").remove();

        mocha.suite.suites = [];

        const code = editor.getValue();
        (new Function(code))();

        mocha.run();

        tries.push({
          code,
          report: document.getElementById("mocha").lastChild
        });
      });
    </script>

    <button id='prettify'>prettify code</button>
    <script>
      document.getElementById('prettify').onclick = function () {
        editor.setValue(
          prettier.format(
            editor.getValue(),
            {
              parser: "babylon",
              plugins: prettierPlugins
            }
          )
        )
      };
    </script>

    <button id='gen-permalink'>generate permalink:</button>
    <input id='permalink' placeholder="link will be here">
    <script>
      document.getElementById('gen-permalink')
        .addEventListener('click', function () {
          const code = editor.getValue();
          const url = generate_permalink(code, encode_query, 'tdd');
          const perma_display = document.getElementById("permalink");
          perma_display.value = url;
          copy_to_clipboard(url);
          alert('copied permalink');
        })
    </script>

    <details id='exercise-details'>
      <summary>select a new exercise</summary>
    </details>
    <script src="./exercises/loader.js"></script>

    <script>
      document.body.appendChild(document.createElement('hr'));
    </script>
  </header>



  <div id='flexy' style='height:90vh; display:flex; flex-direction: row;'>
    <div id="editor" style=" width:65%; height: 100%;"></div>
    <div id="mocha" style='width:45%;margin-top:0;max-height:100%;overflow-y:scroll'></div>
  </div>


  <script>
    const LastSlashIndex = window.location.href.lastIndexOf('/');
    var href = window.location.href.substr(0, LastSlashIndex);

    var tries = [];

    var editor = ace.edit("editor");
    editor.setTheme('ace/theme/chrome');
    editor.setFontSize(12);
    editor.getSession().setMode('ace/mode/javascript');
    editor.getSession().setTabSize(2);

    // coming soon
    // var query = read_snippet_query();
    // if (query) {
    //   // https://prettier.io/blog/2018/05/27/1.13.0.html
    //   editor.setValue(prettier.format(query, {
    //     parser: "babylon",
    //     plugins: prettierPlugins
    //   }));
    //   editor.resize(true);
    // } else {
    editor.setValue(`describe("behavior", function() {
  it("should 1", function() {
    assert.ok("ok");
    assert.ok("");
  });

  it("should 2", function() {
    assert.ok("fine");
    assert.ok("yups");
  });
});
`);
    // };

    // https://ace.c9.io/demo/autoresize.html

  </script>

</body>

</html>
